<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin ¬∑ CRUD</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#0b1220;color:#e5e7eb;margin:0}
    .wrap{max-width:1200px;margin:16px auto;padding:16px}
    h1{margin:0 0 8px} h2{margin:18px 0 8px}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    input,select,button{padding:10px;border-radius:10px;border:1px solid #334155;background:#0f172a;color:#e5e7eb}
    button{background:#22c55e;color:#053;border:none;font-weight:700;cursor:pointer}
    table{width:100%;border-collapse:collapse;background:#0f172a;border-radius:10px;overflow:hidden}
    th,td{padding:8px;border-bottom:1px solid #1f2937;font-size:14px}
    th{background:#111827;text-align:left}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .actions button{margin-right:6px}
    .muted{opacity:.8}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Panel Admin</h1>
    <p class="muted">Gestion√° equipos, torneos, partidos y jugadores. Us√° <b>/control</b> para producci√≥n.</p>

    <div class="grid">
      <section>
        <h2>Equipos</h2>
        <div class="row">
          <input id="team_name" placeholder="Nombre del equipo"/>
          <input id="team_short" placeholder="Abreviado (opcional)"/>
          <button onclick="createTeam()">Crear</button>
        </div>
        <table id="teams_tbl"><thead><tr><th>ID</th><th>Nombre</th><th>Abrev.</th><th>Acciones</th></tr></thead><tbody></tbody></table>
      </section>

      <section>
        <h2>Torneos</h2>
        <div class="row">
          <input id="tourn_name" placeholder="Nombre del torneo"/>
          <input id="tourn_season" placeholder="Temporada (ej: 2025)"/>
          <select id="tourn_ruleset"></select>
          <select id="tourn_type">
            <option value="round_robin">Round Robin</option>
            <option value="bracket">Eliminaci√≥n</option>
          </select>
          <button onclick="createTournament()">Crear</button>
        </div>
        <table id="tourn_tbl"><thead><tr><th>ID</th><th>Nombre</th><th>Temp.</th><th>Ruleset</th><th>Tipo</th><th>Acciones</th></tr></thead><tbody></tbody></table>
      </section>
    </div>

    <section>
      <h2>Partidos</h2>
      <div class="row">
        <select id="match_tournament"></select>
        <select id="match_home"></select>
        <select id="match_away"></select>
        <input id="match_date" placeholder="Fecha ISO (opcional)"/>
        <input id="match_gym" placeholder="Gimnasio (opcional)"/>
        <button onclick="createMatch()">Crear</button>
      </div>
      <table id="matches_tbl"><thead><tr><th>ID</th><th>Match</th><th>Estado</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody></tbody></table>
    </section>

    <section>
      <h2>Jugadores</h2>
      <div class="row">
        <select id="players_team"></select>
        <input id="player_number" placeholder="N¬∞"/>
        <input id="player_name" placeholder="Nombre"/>
        <input id="player_role" placeholder="Rol (OH/MB/S/OP/L, etc.)"/>
        <label><input type="checkbox" id="player_libero"/> L√≠bero</label>
        <button onclick="createPlayer()">Agregar</button>
      </div>
      <table id="players_tbl"><thead><tr><th>ID</th><th>#</th><th>Nombre</th><th>Rol</th><th>L</th><th>Acciones</th></tr></thead><tbody></tbody></table>
    </section>
  </div>

<script>
function esc(s){return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]))}
//funcion async(este tipo de funcion se usa para manejar operaciones que toman tiempo, como cargar datos de una API, esto permite que el codigo espere a que la operacion termine antes de continuar)
async function loadRulesets(){
  const res = await fetch('/api/rulesets'); const rs = await res.json();
  const sel = document.getElementById('tourn_ruleset');
  sel.innerHTML = ''; rs.forEach(r=>{ const o=document.createElement('option'); o.value=r.id; o.textContent=r.name; sel.appendChild(o); });
}
async function loadTeams(){
  const res = await fetch('/api/teams'); const data = await res.json();
  const tbl = document.querySelector('#teams_tbl tbody'); tbl.innerHTML = '';
  const sels = [document.getElementById('match_home'), document.getElementById('match_away'), document.getElementById('players_team')];
  sels.forEach(s=> s.innerHTML='');
  data.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.id}</td><td><input value="${esc(t.name)}" data-team="${t.id}" class="edit team_name"/></td>
                    <td><input value="${esc(t.short||'')}" data-team="${t.id}" class="edit team_short"/></td>
                    <td class="actions">
                      <button onclick="saveTeam(${t.id})">üíæ</button>
                      <button onclick="deleteTeam(${t.id})">üóëÔ∏è</button>
                    </td>`;
    tbl.appendChild(tr);
    sels.forEach(sel=>{ const opt=document.createElement('option'); opt.value=t.id; opt.textContent=t.name; sel.appendChild(opt); });
  });
}
async function loadTournaments(){
  const res = await fetch('/api/tournaments'); const data = await res.json();
  const tbl = document.querySelector('#tourn_tbl tbody'); tbl.innerHTML = '';
  const sel = document.getElementById('match_tournament'); sel.innerHTML='';
  data.forEach(t=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${t.id}</td>
                    <td><input value="${esc(t.name)}" data-tourn="${t.id}" class="edit tourn_name"/></td>
                    <td><input value="${esc(t.season||'')}" data-tourn="${t.id}" class="edit tourn_season"/></td>
                    <td>${t.ruleset}</td>
                    <td>
                      <select data-tourn="${t.id}" class="edit tourn_type">
                        <option value="round_robin"${t.type==='round_robin'?' selected':''}>Round Robin</option>
                        <option value="bracket"${t.type==='bracket'?' selected':''}>Eliminaci√≥n</option>
                      </select>
                    </td>
                    <td class="actions">
                      <button onclick="saveTournament(${t.id})">üíæ</button>
                      <button onclick="deleteTournament(${t.id})">üóëÔ∏è</button>
                    </td>`;
    tbl.appendChild(tr);
    const opt=document.createElement('option'); opt.value=t.id; opt.textContent=`${t.name} (${t.season||''})`; sel.appendChild(opt);
  });
  await loadMatches();
}
async function loadMatches(){
  const tid = document.getElementById('match_tournament').value;
  const url = tid ? `/api/matches?tournament_id=${encodeURIComponent(tid)}` : '/api/matches';
  const res = await fetch(url); const data = await res.json();
  const tbl = document.querySelector('#matches_tbl tbody'); tbl.innerHTML='';
  data.forEach(m=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.id}</td><td>${m.label}</td>
                    <td><input value="${esc(m.status||'scheduled')}" data-match="${m.id}" class="edit match_status"/></td>
                    <td><input value="${esc(m.date||'')}" data-match="${m.id}" class="edit match_date"/></td>
                    <td class="actions">
                      <button onclick="saveMatch(${m.id})">üíæ</button>
                      <button onclick="deleteMatch(${m.id})">üóëÔ∏è</button>
                    </td>`;
    tbl.appendChild(tr);
  });
}
async function loadPlayers(){
  const team_id = document.getElementById('players_team').value;
  if(!team_id){ document.querySelector('#players_tbl tbody').innerHTML=''; return; }
  const res = await fetch('/api/players?team_id='+encodeURIComponent(team_id)); const data = await res.json();
  const tbl = document.querySelector('#players_tbl tbody'); tbl.innerHTML='';
  data.forEach(p=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${p.id}</td>
                    <td><input value="${esc(p.number||'')}" data-player="${p.id}" class="edit pl_number"/></td>
                    <td><input value="${esc(p.name)}" data-player="${p.id}" class="edit pl_name"/></td>
                    <td><input value="${esc(p.role||'')}" data-player="${p.id}" class="edit pl_role"/></td>
                    <td><input type="checkbox" ${p.libero?'checked':''} data-player="${p.id}" class="edit pl_libero"/></td>
                    <td class="actions">
                      <button onclick="savePlayer(${p.id})">üíæ</button>
                      <button onclick="deletePlayer(${p.id})">üóëÔ∏è</button>
                    </td>`;
    tbl.appendChild(tr);
  });
}

async function createTeam(){
  const name = document.getElementById('team_name').value.trim();
  const short = document.getElementById('team_short').value.trim();
  if(!name) return alert('Nombre requerido');
  const res = await fetch('/api/admin/team',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, short})});
  const data = await res.json(); if(!data.ok){ alert(data.error||'Error'); return; }
  document.getElementById('team_name').value=''; document.getElementById('team_short').value='';
  await loadTeams(); await loadPlayers();
}
async function saveTeam(id){
  const name = document.querySelector(`.team_name[data-team="${id}"]`).value.trim();
  const short = document.querySelector(`.team_short[data-team="${id}"]`).value.trim();
  const res = await fetch('/api/admin/team/'+id,{method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, short})});
  const data = await res.json(); if(!data.ok){ alert(data.error||'Error'); }
}
async function deleteTeam(id){
  if(!confirm('¬øBorrar equipo?')) return;
  const res = await fetch('/api/admin/team/'+id,{method:'DELETE'});
  const data = await res.json(); if(!data.ok){ alert(data.error||data.error); return; }
  await loadTeams(); await loadPlayers(); await loadMatches();
}

async function createTournament(){
  const name = document.getElementById('tourn_name').value.trim();
  const season = document.getElementById('tourn_season').value.trim();
  const ruleset_id = document.getElementById('tourn_ruleset').value;
  const type = document.getElementById('tourn_type').value;
  if(!name || !ruleset_id) return alert('Nombre y ruleset requeridos');
  const res = await fetch('/api/admin/tournament',{method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, season, ruleset_id:Number(ruleset_id), type})});
  const data = await res.json(); if(!data.ok){ alert(data.error||'Error'); return; }
  document.getElementById('tourn_name').value=''; document.getElementById('tourn_season').value='';
  await loadTournaments();
}
async function saveTournament(id){
  const name = document.querySelector(`.tourn_name[data-tourn="${id}"]`).value.trim();
  const season = document.querySelector(`.tourn_season[data-tourn="${id}"]`).value.trim();
  const type = document.querySelector(`.tourn_type[data-tourn="${id}"]`).value;
  const res = await fetch('/api/admin/tournament/'+id,{method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({name, season, type})});
  const data = await res.json(); if(!data.ok){ alert(data.error||'Error'); }
}
async function deleteTournament(id){
  if(!confirm('¬øBorrar torneo?')) return;
  const res = await fetch('/api/admin/tournament/'+id,{method:'DELETE'});
  const data = await res.json(); if(!data.ok){ alert(data.error||'Error'); return; }
  await loadTournaments(); await loadMatches();
}

async function createMatch(){
  const tournament_id = Number(document.getElementById('match_tournament').value);
  const home_id = Number(document.getElementById('match_home').value);
  const away_id = Number(document.getElementById('match_away').value);
  const date = document.getElementById('match_date').value.trim();
  const gym = document.getElementById('match_gym').value.trim();
  if(!tournament_id || !home_id || !away_id) return alert('Torneo y equipos requeridos');
  const res = await fetch('/api/admin/match',{method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({tournament_id, home_id, away_id, date: date||undefined, gym: gym||undefined})});
  const data = await res.json(); if(!data.ok){ alert(data.error||'Error'); return; }
  document.getElementById('match_date').value=''; document.getElementById('match_gym').value='';
  await loadMatches();
}
async function saveMatch(id){
  const status = document.querySelector(`.match_status[data-match="${id}"]`).value.trim();
  const date = document.querySelector(`.match_date[data-match="${id}"]`).value.trim();
  const res = await fetch('/api/admin/match/'+id,{method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({status, date})});
  const data = await res.json(); if(!data.ok){ alert(data.error||'Error'); }
}
async function deleteMatch(id){
  if(!confirm('¬øBorrar partido? (No debe tener eventos)')) return;
  const res = await fetch('/api/admin/match/'+id,{method:'DELETE'});
  const data = await res.json(); if(!data.ok){ alert(data.error||'Error'); return; }
  await loadMatches();
}

async function createPlayer(){
  const team_id = Number(document.getElementById('players_team').value);
  const number = Number(document.getElementById('player_number').value)||null;
  const name = document.getElementById('player_name').value.trim();
  const role = document.getElementById('player_role').value.trim();
  const libero = document.getElementById('player_libero').checked;
  if(!team_id || !name) return alert('Equipo y nombre requeridos');
  const res = await fetch('/api/admin/player',{method:'POST', headers:{'Content-Type':'application/json'},
               body: JSON.stringify({team_id, number, name, role, libero})});
  const data = await res.json(); if(!data.ok){ alert(data.error||'Error'); return; }
  document.getElementById('player_number').value=''; document.getElementById('player_name').value=''; document.getElementById('player_role').value=''; document.getElementById('player_libero').checked=false;
  await loadPlayers();
}
async function savePlayer(id){
  const number = document.querySelector(`.pl_number[data-player="${id}"]`).value;
  const name = document.querySelector(`.pl_name[data-player="${id}"]`).value.trim();
  const role = document.querySelector(`.pl_role[data-player="${id}"]`).value.trim();
  const libero = document.querySelector(`.pl_libero[data-player="${id}"]`).checked;
  const res = await fetch('/api/admin/player/'+id,{method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify({number: Number(number)||null, name, role, libero})});
  const data = await res.json(); if(!data.ok){ alert(data.error||'Error'); }
}
async function deletePlayer(id){
  if(!confirm('¬øBorrar jugador?')) return;
  const res = await fetch('/api/admin/player/'+id,{method:'DELETE'});
  const data = await res.json(); if(!data.ok){ alert(data.error||'Error'); return; }
  await loadPlayers();
}

document.getElementById('players_team').addEventListener('change', loadPlayers);

(async function bootstrap(){
  await loadRulesets();
  await loadTeams();
  await loadTournaments();
  await loadPlayers();
})();
</script>
</body>
</html>
